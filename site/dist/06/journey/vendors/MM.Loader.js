function getWorkerInstance(t){var e=window.URL||window.webkitURL;if(void 0==e||void 0==window.Blob||void 0==window.Worker||void 0==t)return null;var s=new Blob([t]),r=e.createObjectURL(s),o=new Worker(r);return e.revokeObjectURL(r),o}var MM=MM||{};"object"==typeof module&&(module.exports=MM),MM.Loader=function(){function t(){this._maxConnections=1,this._numItems=0,this._numItemsLoaded=0,this._paused=!1,this._currentLoads=[],this._loadQueue=[],this._loadedItemsById={},this._loadedItemsBySrc={},this._loadStartWasDispatched=!1,this.loaded=!1,this.progress=0,this.onProgress=null,this.onLoadStart=null,this.onFileLoad=null,this.onFileProgress=null,this.onComplete=null,this.onError=null,this.workerXHR=getWorkerInstance(document.getElementById("worker-xhr").textContent),self=this,this.workerXHR.onmessage=function(t){switch(data=t.data,data.proxy){case"onloadstart":break;case"onloadprogress":self._handleProgress(data.data);break;case"onfileprogress":break;case"oncomplete":self._handleFileComplete(data.data);break;case"onfilecomplete":break;case"onerror":self._handleFileError(data.data)}}}return t.prototype._sendLoadStart=function(){this.onLoadStart&&this.onLoadStart({target:this})},t.prototype._sendProgress=function(t){var e;t instanceof Number?(this.progress=t,e={loaded:this.progress,total:1}):(e=t,this.progress=t.loaded/t.total),e.target=this,this.onProgress&&this.onProgress(e)},t.prototype._sendFileProgress=function(t){this.onFileProgress&&(t.target=this,this.onFileProgress(t))},t.prototype._sendComplete=function(){this.onComplete&&this.onComplete({target:this})},t.prototype._sendFileComplete=function(t){this.onFileLoad&&(t.target=this,this.onFileLoad(t))},t.prototype._sendError=function(t){this.onError&&(null===t&&(t={}),t.target=this,this.onError(t))},t.prototype.setMaxConnections=function(t){this._maxConnections=t,this._paused||this._loadNext()},t.prototype.loadManifest=function(t){var e;if(t instanceof Array){if(0===t.length)return void this._sendError({text:"Manifest is empty."});e=t}else{if(null===t)return void this._sendError({text:"Manifest is null."});e=[t]}for(var s=0;s<e.length;s++)this._addItem(e[s]);this._updateProgress(),this._loadNext()},t.prototype.load=function(){this.setPaused(!1)},t.prototype.getResult=function(t){return this._loadedItemsById[t]||this._loadedItemsBySrc[t]},t.prototype.setPaused=function(t){this._paused=t,this._paused||this._loadNext()},t.prototype.close=function(){for(;this._currentLoads.length;)this._currentLoads.pop().cancel();this._currentLoads=[],this._scriptOrder=[],this._loadedScripts=[]},t.prototype._addItem=function(t){var e=this._createLoadItem(t);null!==e&&(this._loadQueue.push(e),this._numItems++)},t.prototype._loadNext=function(){var t;if(!this._paused)for(this._loadStartWasDispatched||(this._sendLoadStart(),this._loadStartWasDispatched=!0),this._numItems===this._numItemsLoaded&&(this.loaded=!0,this._sendComplete());this._loadQueue.length&&this._currentLoads.length<this._maxConnections;)t=this._loadQueue.shift(),this._currentLoads.push(t)},t.prototype._handleFileError=function(t){var e=t.target,s=this._createResultData(e._item);this._numItemsLoaded++,this._updateProgress(),this._sendError(s),this._removeLoadItem(e),this._loadNext()},t.prototype._createResultData=function(t){var e={id:t.id,result:null,data:t.data,type:t.type,src:t.src};return this._loadedItemsById[t.id]=e,this._loadedItemsBySrc[t.src]=e,e},t.prototype._handleFileComplete=function(t){var e=t.target,s=e._item,r=this._createResultData(s);switch(this._removeLoadItem(e),r.result=this._createResult(s,e._request.response),s.type){case"image":var o=this;return void(r.result.onload=function(){o._handleFileTagComplete(s,r)});case"svg":case"sound":}this._handleFileTagComplete(s,r)},t.prototype._handleFileTagComplete=function(t,e){this._numItemsLoaded++,t.completeHandler&&t.completeHandler(e),this._updateProgress(),this._sendFileComplete(e),this._loadNext()},t.prototype._removeLoadItem=function(t){for(var e=this._currentLoads.length,s=0;e>s;s++)if(this._currentLoads[s]===t)return void this._currentLoads.splice(s,1)},t.prototype._createResult=function(t,e){var s,r=null;switch(t.type){case"image":r=this._createImage();break;case"sound":r=t.tag||this._createAudio();break;case"css":r=this._createLink();break;case"svg":r=this._createSVG(),r.appendChild(this._createXML(e,"image/svg+xml"));break;case"xml":s=this._createXML(e,"text/xml");break;case"json":case"text":s=e}return r?("css"===t.type?r.href=t.src:"svg"!==t.type&&(r.src=t.src),r):s},t.prototype._createXML=function(t,e){var s,r;return window.DOMParser?(r=new DOMParser,s=r.parseFromString(t,e)):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async=!1,r.loadXML(t),s=r),s},t.prototype._handleProgress=function(t){var e=t.target,s=this._createResultData(e._item);s.progress=e.progress,this._sendFileProgress(s),this._updateProgress()},t.prototype._updateProgress=function(){var t=this._numItemsLoaded/this._numItems,e=this._numItems-this._numItemsLoaded;if(e>0){for(var s=0,r=0,o=this._currentLoads.length;o>r;r++)void 0==this._currentLoads[r].progress&&(this._currentLoads[r].progress=0),s+=this._currentLoads[r].progress;t+=s/e*(e/this._numItems)}this._sendProgress({loaded:t,total:1})},t.prototype._createLoadItem=function(t){var e={};switch(typeof t){case"string":e.src=t;break;case"object":t instanceof HTMLAudioElement?(e.tag=t,e.src=e.tag.src,e.type="sound"):e=t}return e.extension=this._getNameAfter(e.src,"."),e.type||(e.type=this.getType(e.extension)),(null===e.id||""===e.id)&&(e.id=e.src),this.workerXHR.postMessage(e),e},t.prototype.getType=function(t){switch(t){case"jpeg":case"jpg":case"gif":case"png":case"webp":case"bmp":return"image";case"ogg":case"mp3":case"webm":return"sound";case"json":return"json";case"xml":return"xml";case"css":return"css";case"svg":return"svg";default:return"text"}},t.prototype._getNameAfter=function(t,e){var s=t.lastIndexOf(e),r=t.substr(s+1),o=r.lastIndexOf(/[\b|\?|#|\s]/);return-1===o?r:r.substr(0,o)},t.prototype._createImage=function(){return document.createElement("img")},t.prototype._createSVG=function(){var t=document.createElement("object");return t.type="image/svg+xml",t},t.prototype._createAudio=function(){var t=document.createElement("audio");return t.autoplay=!1,t.type="audio/ogg",t},t.prototype._createScript=function(){var t=document.createElement("script");return t.type="text/javascript",t},t.prototype._createLink=function(){var t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t},t}();