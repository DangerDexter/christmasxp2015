$(document).ready(function(){function r(){function a(a){document.pointerLockElement===l||document.mozPointerLockElement===l||document.webkitPointerLockElement===l?(n.enabled=!0,H(!1)):(n.enabled=!1,H(!0))}aa();$("#landing .start").on("click",function(a){B=!0;p=!1;$("#ui .focus, #ui-stereo .focus-left, #ui-stereo .focus-right").show();TweenMax.to($("#landing"),.5,{opacity:0,display:"none"});N();ga("send","event","game","start-game");ga("send","pageview","start-game")});$("#result .playagain").on("click",
function(a){p=!1;B=!0;E=0;x=100;y=0;z=120;for(b=0;b<h.length;b++)f.remove(h[b]);h=[];A=[];d=[];TweenMax.to($("#result"),.5,{opacity:0,display:"none"});$(".status .hp .bar").attr("style","");$(".status .score").html(0);$("#ui .focus, #ui-stereo .focus-left, #ui-stereo .focus-right").show();N();ga("send","event","result","restart-game");ga("send","pageview","start-game")});$("#result .back").on("click",function(a){TweenMax.to($("#landing"),.5,{opacity:1,display:"block"});TweenMax.to($("#result"),.5,
{opacity:0,display:"none"});p=!0;B=!1;E=0;x=100;y=0;z=120;for(b=0;b<h.length;b++)f.remove(h[b]);h=[];A=[];d=[];$(".status .hp .bar").attr("style","");$(".status .score").html(0);ga("send","event","result","back-to-homepage");ga("send","pageview","homepage")});$("#result .credits").on("click",function(a){TweenMax.to($("#credits"),.5,{opacity:1,display:"block"});ga("send","event","result","credits");ga("send","pageview","credits")});$("#credits .back").on("click",function(a){TweenMax.to($("#credits"),
.5,{opacity:0,display:"none"})});window.addEventListener("focus",function(){},!1);window.addEventListener("blur",function(){H(!0)},!1);q.setClearColor(2506599);q.setSize(window.innerWidth,window.innerHeight);q.setPixelRatio(window.devicePixelRatio);q.shadowMap.type=THREE.PCFShadowMap;q.shadowMap.enabled=!0;g.position.set(0,30,10);g.target=new THREE.Vector3(0,30,-10);C?(I=new THREE.StereoEffect(q),I.focalLength=22,$("#ui").hide()):$("#ui-stereo").hide();var c=new THREE.DirectionalLight(16777215,.4);
c.position.set(.5,1,.5).normalize();f.add(c);c=new THREE.DirectionalLight(16777215,.4);c.position.set(-.5,1,-.5).normalize();f.add(c);c=new THREE.HemisphereLight(0,16777215,.5);f.add(c);c=new THREE.PointLight(16777215,.7);c.position.set(0,50,0);f.add(c);C||(n=new THREE.PointerLockControls(g),f.add(n.getObject()),$(".pause").click(function(a){N()}),document.addEventListener("pointerlockchange",a,!1),document.addEventListener("mozpointerlockchange",a,!1),document.addEventListener("webkitpointerlockchange",
a,!1));R=THREE.ImageUtils.loadTexture("assets/images/textures/moon.png");c=new THREE.SpriteMaterial({map:R});c=new THREE.Sprite(c);c.position.set(500,500,-700);c.scale.set(400,400,1);f.add(c);c=new THREE.SpriteMaterial({map:ba});c=new THREE.Sprite(c);c.position.set(0,500,-450);c.scale.set(100,50,1);f.add(c);var c=new THREE.SphereGeometry(3,3,3),e=new THREE.MeshLambertMaterial({color:13421772});S=new THREE.Mesh(c,e);F=new SPE.Group({texture:{value:THREE.ImageUtils.loadTexture("assets/images/textures/dot.jpg")}});
T=new SPE.Emitter({maxAge:{value:35},position:{value:new THREE.Vector3(0,200,0),spread:new THREE.Vector3(300,0,300)},velocity:{value:new THREE.Vector3(2,-10,0),spread:new THREE.Vector3(1,5,1)},size:{value:.5},particleCount:6E3});F.addEmitter(T);f.add(F.mesh);F.tick(20);$(window).resize(U);q.render(f,g);V();U()}function aa(){createjs.Sound.on("fileload",function(a){"bgm"==a.id&&(createjs.Sound.play("bgm",{loop:-1}),$("#music-switch").on("click",function(a){a=$(this).attr("data-status");0==a&&(createjs.Sound.play("bgm",
{loop:-1}),$(this).attr("data-status","1"),$(this).children("span").html(" ON"));1==a&&(createjs.Sound.stop(),$(this).attr("data-status","0"),$(this).children("span").html(" OFF"))}))},this);createjs.Sound.registerSound("assets/sounds/bgm.mp3","bgm")}function H(a){B&&(void 0!==a&&(p=!a),p?($("#ui .focus, #ui-stereo .focus-left, #ui-stereo .focus-right").show(),TweenMax.resumeAll(),TweenMax.to($(".pause"),.25,{opacity:0,display:"none"}),p=!1):($("#ui .focus, #ui-stereo .focus-left, #ui-stereo .focus-right").hide(),
TweenMax.pauseAll(),TweenMax.to($(".pause"),.25,{opacity:1,display:"block"}),p=!0))}function ca(){document.body.requestFullscreen?document.body.requestFullscreen():document.body.msRequestFullscreen?document.body.msRequestFullscreen():document.body.mozRequestFullScreen?document.body.mozRequestFullScreen():document.body.webkitRequestFullscreen&&document.body.webkitRequestFullscreen()}function N(){n.enabled=!0;$("html").hasClass("mobile")||$("html").hasClass("ios")||(l.requestPointerLock=l.requestPointerLock||
l.mozRequestPointerLock||l.webkitRequestPointerLock,l.requestPointerLock())}function da(a){x-=5;f.remove(a);TweenMax.fromTo($(".hurt"),.4,{opacity:.4},{opacity:0});0<=x?$(" .hp .bar").css("width",x+"%"):B&&(x=0,p=!0,B=!1,$("#ui .focus, #ui-stereo .focus-left, #ui-stereo .focus-right").hide(),$("#result .score").html(y),TweenMax.to($("#result"),.5,{opacity:1,display:"block"}),ga("send","pageview","end-game"),ga("send","event","game","end-game","score",y),n.enabled=!1,$("html").hasClass("mobile")||
$("html").hasClass("ios")||(document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock()))}function ea(a){a.isJumping=!1}function V(){requestAnimationFrame(V);if(!p){for(b=0;b<d.length;b++)if(200<d[b].r)0==d[b].isJumping&&(0==d[b].jumpDelay?(d[b].jumpDelay=30,d[b].isJumping=!0,m=d[b].r-=20,t=m*Math.cos(d[b].theta),u=m*Math.sin(d[b].theta),TweenMax.to(h[b].position,.25,{x:t,y:0,z:u,ease:Power1.easeOut}),m=d[b].r-=20,t=m*Math.cos(d[b].theta),
u=m*Math.sin(d[b].theta),TweenMax.to(h[b].position,.25,{x:t,y:-10,z:u,delay:.25,ease:Power1.easeIn}),TweenMax.to(h[b].getObjectByName("hat").position,.25,{y:4,delay:.25}),TweenMax.to(h[b].getObjectByName("hat").position,.25,{y:0,delay:.5}),TweenMax.to(h[b].scale,.15,{y:1.1,ease:Power1.easeOut}),TweenMax.to(h[b].scale,.15,{y:.9,delay:.5,ease:Power2.easeOut}),TweenMax.to(h[b].scale,.15,{y:1,delay:.65,ease:Power2.easeIn,onComplete:ea,onCompleteParams:[d[b]]})):d[b].jumpDelay--);else if(d[b].attack++,
120<=d[b].attack){var a=S.clone();f.add(a);TweenMax.fromTo(a.position,.5,{x:h[b].position.x,y:h[b].position.y+10,z:h[b].position.z},{x:g.position.x,y:g.position.y,z:g.position.z,ease:Linear.easeNone,onComplete:da,onCompleteParams:[a]});d[b].attack=0}TweenMax.set($(".focus-progress circle, .focus-progress-left circle, .focus-progress-right circle"),{"stroke-dashoffset":v/100*150});W.setFromCamera({x:0,y:0},g);a=W.intersectObjects(A);if(0<a.length){if(v-=8,0>v){var c=O.clone();b=Math.floor(Math.random()*
X.length);c.getObjectByName("body").material=new THREE.MeshLambertMaterial({color:X[b]});f.add(c);var e,k=a[0].point.x,l=a[0].point.z;e=Math.sqrt((k-=g.position.x)*k+(l-=g.position.z)*l);TweenMax.fromTo(c.rotation,.004*e,{x:0,y:0,z:0},{x:-1,y:1,z:1,ease:Linear.easeNone});for(b=0;b<A.length;b++)if(a[0].object.uuid==A[b].uuid){TweenMax.fromTo(c.position,.004*e,{x:g.position.x,y:g.position.y-20,z:g.position.z},{x:a[0].point.x,y:a[0].point.y,z:a[0].point.z,ease:Linear.easeNone,onComplete:fa,onCompleteParams:[a[0].object.parent,
c,d[b]]});d.splice(b,1);h.splice(b,1);A.splice(b,1);break}v=100}}else 100>v&&(v+=8);P++;if(P>z){if(!p){a=w.clone();a.getObjectByName("face").material=new THREE.MeshLambertMaterial({map:G,transparent:!0});a.getObjectByName("hat").material=new THREE.MeshLambertMaterial({color:Y[Math.floor(Math.random()*Y.length)]});D=THREE.Math.degToRad(360*Math.random());c=!1;for(b=Q=0;b<d.length;b++)if(.3>Math.abs(d[b].theta-D)&&(b=-1,D=THREE.Math.degToRad(360*Math.random()),Q++,5E3<Q)){c=!0;break}c||(m=150*Math.random()+
380,J=-80,t=m*Math.cos(D),u=m*Math.sin(D),a.position.set(t,J,u),a.scale.set(1,1,1),a.lookAt(g.position),h.push(a),A.push(a.getObjectByName("hittest")),d.push({theta:D,r:m,attack:0,y:20,isJumping:!1,jumpDelay:0}),f.add(a))}P=0}F.tick(ha.getDelta());C?(n.update(),I.render(f,g)):q.render(f,g);E++;480<E&&(E=0,z-=15,30>z&&(z=30))}}function fa(a,b,d){a.getObjectByName("face").material.map=K;m=d.r-10;J=6;t=m*Math.cos(d.theta);u=m*Math.sin(d.theta);b.position.set(t,J,u);b.lookAt(new THREE.Vector3(0,0,0));
b.rotation.y+=THREE.Math.degToRad(30);a.getObjectByName("hand-left").rotation.y=THREE.Math.degToRad(90);a.getObjectByName("hand-left").position.set(7,-2,5);a.getObjectByName("hand-right").rotation.y=THREE.Math.degToRad(-90);a.getObjectByName("hand-right").position.set(-7,-2,5);TweenMax.to(b.position,1,{delay:1,y:-80,ease:Power3.easeIn});TweenMax.to(a.position,1,{delay:1,y:-80,ease:Power3.easeIn,onComplete:ia,onCompleteParams:[a,b]});y+=10;$(".score").html(y)}function ia(a,b){f.remove(a);f.remove(b)}
function U(){L=window.innerWidth;M=window.innerHeight;g.aspect=L/M;g.updateProjectionMatrix();q.setSize(L,M);C&&I.setSize(L,M)}var b,m,t,J,u,D,L,M,f=new THREE.Scene,g=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,1,1E4),k=document.getElementById("threejs-container"),q;q=$("html").hasClass("mobile")?new THREE.WebGLRenderer({canvas:k,antialias:!1}):new THREE.WebGLRenderer({canvas:k,antialias:!0});var C=!1,I,h=[],d=[],A=[],W=new THREE.Raycaster,n,B=!1,p=!0,v=100,x=100,y=0;new THREE.Object3D;
var Q=0,T,F,e=0,ha=new THREE.Clock,P=0,R,l=document.body,S,X=[16347505,7129965,8436191,14344277,11882684,5228185,14781003],Y=[13904169,4896562,4288199],w=new THREE.Object3D,O=new THREE.Object3D,z=120,E=0,ba=THREE.ImageUtils.loadTexture("assets/images/textures/ufo.png"),G=THREE.ImageUtils.loadTexture("assets/images/textures/face.png");G.wrapS=G.wrapT=THREE.RepeatWrapping;G.repeat.set(1,1);var K=THREE.ImageUtils.loadTexture("assets/images/textures/face2.png");K.wrapS=K.wrapT=THREE.RepeatWrapping;K.repeat.set(1,
1);$("html").hasClass("mobile")&&(C=!0);k=new THREE.ObjectLoader;k.load("assets/scripts/model/snowman-head.js",function(a){a.name="head";w.add(a);a.material=new THREE.MeshLambertMaterial({color:16777215});a.castShadow=!0;e++;8==e&&r()});k.load("assets/scripts/model/snowman-body.js",function(a){a.name="body";w.add(a);a.children[0].material=new THREE.MeshLambertMaterial({color:15658734});a.children[1].material=new THREE.MeshLambertMaterial({color:4992512});a.children[2].material=new THREE.MeshLambertMaterial({color:8937984});
a=new THREE.PlaneGeometry(25,40,1,1);var b=new THREE.MeshLambertMaterial({color:16711680,transparent:!0,opacity:0});a=new THREE.Mesh(a,b);a.position.set(0,20,10);a.rotation.set(THREE.Math.degToRad(0),0,0);a.name="hittest";w.add(a);a=new THREE.PlaneGeometry(12,12,1,1);b=new THREE.MeshLambertMaterial({map:G,transparent:!0});a=new THREE.Mesh(a,b);a.position.set(0,25,13);a.rotation.set(THREE.Math.degToRad(0),0,0);a.name="face";w.add(a);e++;8==e&&r()});k.load("assets/scripts/model/snowman-hat.js",function(a){a.name=
"hat";w.add(a);e++;8==e&&r()});k.load("assets/scripts/model/snowman-hand-left.js",function(a){a.name="hand-left";a.material=new THREE.MeshLambertMaterial({color:15658734});w.add(a);e++;8==e&&r()});k.load("assets/scripts/model/snowman-hand-right.js",function(a){a.name="hand-right";a.material=new THREE.MeshLambertMaterial({color:15658734});w.add(a);e++;8==e&&r()});k.load("assets/scripts/model/gift-body.js",function(a){a.name="body";O.add(a);e++;8==e&&r()});k.load("assets/scripts/model/gift-ribbon.js",
function(a){a.name="ribbon";O.add(a);e++;8==e&&r()});k.load("assets/scripts/model/snowplane.js",function(a){a.name="snowplane";a.material=new THREE.MeshLambertMaterial({color:16777215,emissive:0});a.scale.set(55,55,55);a.position.set(0,-10,0);f.add(a);e++;8==e&&r()});if(C){var Z=function(a){a.alpha&&(n=new THREE.DeviceOrientationControls(g,!0),n.connect(),n.update(),window.removeEventListener("deviceorientation",Z,!0))};window.addEventListener("deviceorientation",Z,!0);l.addEventListener("click",
ca,!1);$(".pause").click(function(a){H()})}});