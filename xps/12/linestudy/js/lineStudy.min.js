var KEEF=KEEF||{};KEEF.namespace=function(e){var i,t=e.split("."),n=KEEF;for("KEEF"===t[0]&&(t=t.slice(1)),i=0;i<t.length;i+=1)"undefined"==typeof n[t[i]]&&(n[t[i]]={}),n=n[t[i]];return n},KEEF.names=new Array,KEEF.createID=function(e){return KEEF.names.push(e+"_"+KEEF.names.length),KEEF.names.length-1},KEEF.DEBUG=!1,KEEF.winWidth,KEEF.winHeight;var canvasContainer,canvasDiv,canvas,context;KEEF.width=window.innerWidth,KEEF.height=window.innerHeight,KEEF.center={x:KEEF.width/2,y:KEEF.height/2},KEEF.color={white:"#e5dbdb",red:"red",red1:"#ae5c4e",red2:"#FF3333",red3:"#9933FF",red4:"#FF6666",red5:"#FFCCCC",blue:"#9ccccc",black:"#000000",black1:"#282828",black2:"#3A3A3A",black3:"#565656",black4:"#727272",black5:"#999999"},KEEF.frameNum=0,KEEF.totalFrames=0,KEEF.totalLoaded=0,KEEF.loaded=!1,KEEF.totalCached=0,KEEF.totalToCache=0,KEEF.tings=new Array,KEEF.lines=new Array,KEEF.shadows=new Array,KEEF._i=0,canvasDiv=document.getElementById("container"),canvas=document.createElement("canvas"),canvas.width=KEEF.width,canvas.height=KEEF.height,canvasDiv.appendChild(canvas),KEEF.borderCircle,KEEF.border,KEEF.mask,paper.install(window),paper.setup(canvas),KEEF.DEBUG&&(KEEF.stats=new Stats,KEEF.stats.setMode(0),KEEF.stats.domElement.style.position="absolute",KEEF.stats.domElement.style.left="0px",KEEF.stats.domElement.style.top="0px",document.body.appendChild(KEEF.stats.domElement),KEEF.gui=new dat.GUI,KEEF.guiFolder=KEEF.gui.addFolder("Main")),KEEF.load=function(){KEEF.tings.push(new KEEF.Ting("bound",null,1)),KEEF.tings.push(new KEEF.Ting("rightLeaf","img/rightLeaf/",24)),KEEF.tings.push(new KEEF.Ting("leftLeaves","img/leftLeaves/",12)),KEEF.tings.push(new KEEF.Ting("candle","img/candle/",5)),KEEF.tings.push(new KEEF.Ting("lightA","img/candle/",12)),KEEF.tings.push(new KEEF.Ting("lightB","img/candle/",12)),KEEF.tings.push(new KEEF.Ting("window","img/",1)),KEEF.tings.push(new KEEF.Ting("gingerman","img/",1)),KEEF.tings.push(new KEEF.Ting("glassA","img/",1)),KEEF.tings.push(new KEEF.Ting("jugA","img/",1)),KEEF.tings.push(new KEEF.Ting("jugB","img/",1)),KEEF.tings.push(new KEEF.Ting("mugA","img/",1)),KEEF.tings.push(new KEEF.Ting("mugB","img/",1)),KEEF.tings.push(new KEEF.Ting("bottlesA","img/",1)),KEEF.tings.push(new KEEF.Ting("roof","img/",1)),KEEF.tings.push(new KEEF.Ting("table","img/",1)),KEEF.tings.push(new KEEF.Ting("fernA","img/",1)),KEEF.tings.push(new KEEF.Ting("starA","img/",1)),KEEF.tings.push(new KEEF.Ting("starB","img/",1));for(var e=0;e<KEEF.tings.length;e++)KEEF.tings[e].load();KEEF.paperTool=new paper.Tool,KEEF.mouseDown=new paper.Point(0,0),KEEF.mouse=new paper.Point(0,0),KEEF.paperTool.onMouseMove=function(e){KEEF.mouse=e.point},KEEF.loadLoop()},KEEF.allLoaded=function(){KEEF.loaded=!0;for(var e=0;e<KEEF.tings.length;e++)KEEF.tings[e].isLoaded()||(KEEF.loaded=!1);return KEEF.loaded},KEEF.loadLoop=function(){setTimeout(function(){if(KEEF.allLoaded()){for(var e=0;e<paper.project.layers[0].children.length;e++)"bin"==paper.project.layers[0].children[e].data.name&&(paper.project.layers[0].children[e].remove(),e=0);KEEF.lines.push({name:"level4",lines:new KEEF.LineTexture}),KEEF.getLinesByName("level4").lines.init(new paper.Point(0,0),{color:KEEF.color.black4,angle:KEEF.degree2radian(0),numLines:Math.floor(screen.height/12),increment:12,lineLength:KEEF.width,depth:.02}),KEEF.lines.push({name:"level3",lines:new KEEF.LineTexture}),KEEF.getLinesByName("level3").lines.init(new paper.Point(0,0),{color:KEEF.color.black3,angle:KEEF.degree2radian(0),numLines:Math.floor(screen.height/11),increment:11,lineLength:KEEF.width,depth:.04}),KEEF.shadows.push({name:"bottleShadow",shadow:new KEEF.WhiteTexture}),KEEF.getShadowsByName("bottleShadow").shadow.init(new paper.Point(0,0),{depth:.04}),KEEF.lines.push({name:"level2",lines:new KEEF.LineTexture}),KEEF.getLinesByName("level2").lines.init(new paper.Point(0,0),{color:KEEF.color.black2,angle:KEEF.degree2radian(0),numLines:Math.floor(screen.height/6),increment:6,lineLength:KEEF.width,depth:.06}),KEEF.shadows.push({name:"windowShadow",shadow:new KEEF.WhiteTexture}),KEEF.getShadowsByName("windowShadow").shadow.init(new paper.Point(0,0),{depth:.07}),KEEF.shadows.push({name:"leafShadows",shadow:new KEEF.WhiteTexture}),KEEF.getShadowsByName("leafShadows").shadow.init(new paper.Point(0,0),{depth:.1}),KEEF.lines.push({name:"level1.7",lines:new KEEF.LineTexture}),KEEF.getLinesByName("level1.7").lines.init(new paper.Point(200,-300),{color:KEEF.color.black5,angle:KEEF.degree2radian(45),numLines:1.5*Math.floor(screen.height/20),increment:40,lineLength:KEEF.width,depth:.15}),KEEF.lines.push({name:"level1.5",lines:new KEEF.LineTexture}),KEEF.getLinesByName("level1.5").lines.init(new paper.Point(200,300),{color:KEEF.color.black5,angle:KEEF.degree2radian(-45),numLines:1.5*Math.floor(screen.height/20),increment:20,lineLength:KEEF.width,depth:.15}),KEEF.lines.push({name:"level1.2",lines:new KEEF.LineTexture}),KEEF.getLinesByName("level1.2").lines.init(new paper.Point(200,300),{color:KEEF.color.black,angle:KEEF.degree2radian(0),numLines:Math.floor(screen.height/9),increment:9,lineLength:KEEF.width,depth:.15}),KEEF.shadows.push({name:"candleShadows",shadow:new KEEF.WhiteTexture}),KEEF.getShadowsByName("candleShadows").shadow.init(new paper.Point(0,0),{depth:.15}),KEEF.lines.push({name:"level1",lines:new KEEF.LineTexture}),KEEF.getLinesByName("level1").lines.init(new paper.Point(0,0),{color:KEEF.color.black1,angle:KEEF.degree2radian(0),numLines:Math.floor(screen.height/8),increment:8,lineLength:KEEF.width,depth:.15}),KEEF.lines.push({name:"level0",lines:new KEEF.LineTexture}),KEEF.getLinesByName("level0").lines.init(new paper.Point(0,0),{color:KEEF.color.black,angle:KEEF.degree2radian(0),numLines:Math.floor(screen.height/6),increment:6,lineLength:KEEF.width,depth:.2}),KEEF.totalToCache=KEEF.lines.length+KEEF.shadows.length,KEEF.cacheLoop()}else KEEF.loadLoop()},100)},KEEF.cacheThis=0,KEEF.cacheLoop=function(){switch(KEEF.cacheThis){case 0:KEEF.getLinesByName("level4").lines.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("starA"),KEEF.getTingByName("starB")]),KEEF.cacheThis++,setTimeout(function(){KEEF.cacheLoop()},100);break;case 1:KEEF.getLinesByName("level3").lines.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("table"),KEEF.getTingByName("fernA")]),KEEF.cacheThis++,setTimeout(function(){KEEF.cacheLoop()},100);break;case 2:KEEF.getShadowsByName("bottleShadow").shadow.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("gingerman"),KEEF.getTingByName("jugA"),KEEF.getTingByName("jugB"),KEEF.getTingByName("bottlesA"),KEEF.getTingByName("mugA"),KEEF.getTingByName("mugB"),KEEF.getTingByName("glassA")]),KEEF.getLinesByName("level2").lines.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("gingerman"),KEEF.getTingByName("jugA"),KEEF.getTingByName("jugB"),KEEF.getTingByName("bottlesA"),KEEF.getTingByName("mugA"),KEEF.getTingByName("mugB"),KEEF.getTingByName("glassA")]),KEEF.cacheThis++,setTimeout(function(){KEEF.cacheLoop()},100);break;case 3:KEEF.getShadowsByName("windowShadow").shadow.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("window")]),KEEF.cacheThis++,setTimeout(function(){KEEF.cacheLoop()},100);break;case 4:KEEF.getShadowsByName("leafShadows").shadow.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("rightLeaf"),KEEF.getTingByName("leftLeaves")]),KEEF.getLinesByName("level1.7").lines.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("lightB")]),KEEF.cacheThis++,setTimeout(function(){KEEF.cacheLoop()},100);break;case 5:KEEF.getLinesByName("level1.5").lines.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("lightA")]),KEEF.getShadowsByName("candleShadows").shadow.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("candle")]),KEEF.getLinesByName("level1.2").lines.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("candle")]),KEEF.getLinesByName("level1").lines.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("window")]),KEEF.cacheThis++,setTimeout(function(){KEEF.cacheLoop()},100);break;case 6:KEEF.getLinesByName("level0").lines.addClipTings([KEEF.getTingByName("bound"),KEEF.getTingByName("rightLeaf"),KEEF.getTingByName("leftLeaves"),KEEF.getTingByName("roof")]);for(var e=0;e<paper.project.layers[0].children.length;e++){for(var i=10,t=paper.project.layers[0].children[e];i>0&&"Path"!=t.className;)t=t.children[0];"original svgs"==t.data.name&&(paper.project.layers[0].children[e].remove(),e=0)}KEEF.start()}},KEEF.start=function(){console.log("start"),document.getElementById("backgroundNoise").play(),KEEF.snow=new KEEF.SnowTexture,KEEF.snow.init(),KEEF.paperTool.onMouseMove=function(e){KEEF.mouse=e.point},KEEF.count=0;for(var e=0;e<KEEF.lines.length;e++)KEEF.lines[e].lines.setClipPosition(new paper.Point(KEEF.width/2,KEEF.height/2));var i=document.getElementById("loadingText");i.parentNode.removeChild(i),paper.view.onFrame=function(e){KEEF.DEBUG&&KEEF.stats.begin(),KEEF.winWidth=window.innerWidth,KEEF.count++,KEEF.count%4==0&&(KEEF.width=window.innerWidth,KEEF.height=window.innerHeight,KEEF.center={x:KEEF.width/2,y:KEEF.height/2},canvas.width=KEEF.width,canvas.height=KEEF.height,KEEF.update()),KEEF.DEBUG&&KEEF.stats.end()}},KEEF.update=function(){for(KEEF._i=0;KEEF._i<KEEF.lines.length;KEEF._i++)KEEF.lines[KEEF._i].lines.update();for(KEEF._i=0;KEEF._i<KEEF.shadows.length;KEEF._i++)KEEF.shadows[KEEF._i].shadow.update();KEEF.snow.update()},KEEF.getTing=function(e){for(KEEF._i=0;KEEF._i<KEEF.tings.length;KEEF._i++)if(KEEF.tings[KEEF._i].id==e)return KEEF.tings[KEEF._i]},KEEF.getTingByName=function(e){for(KEEF._i=0;KEEF._i<KEEF.tings.length;KEEF._i++)if(KEEF.tings[KEEF._i].name==e)return KEEF.tings[KEEF._i]},KEEF.getLinesByName=function(e){for(KEEF._i=0;KEEF._i<KEEF.lines.length;KEEF._i++)if(KEEF.lines[KEEF._i].name==e)return KEEF.lines[KEEF._i]},KEEF.getShadowsByName=function(e){for(KEEF._i=0;KEEF._i<KEEF.shadows.length;KEEF._i++)if(KEEF.shadows[KEEF._i].name==e)return KEEF.shadows[KEEF._i]},KEEF.distance=function(e,i){var t=e.x-i.x,n=e.y-i.y;return Math.sqrt(t*t+n*n)},KEEF.degree2radian=function(e){return e*(Math.PI/180)},KEEF.radian2degree=function(e){return e*(180/Math.PI)}(function(){if(void 0===KEEF.Ting){KEEF.Ting=function(e,i,t){this.id=KEEF.createID("ting"),this.name=e,this.filePath=i,this.frameNum=0,this.numFrames=t,this.frames=new Array,this.group,this.lines,this.loaded=!1,this.numLoaded=0,KEEF.totalFrames=KEEF.totalFrames+t};var e=KEEF.Ting.prototype;e.init=function(){},e.update=function(e){"bound"!==this.name&&(this.frameNum++,this.frameNum>=this.numFrames&&(this.frameNum=0))},e.reset=function(){this.frameNum=0},e.getCurFrame=function(){return this.frames[this.frameNum]},e.load=function(){if("bound"!==this.name)this.loadingLoop(this.filePath+this.name,0,this.id);else{var e=KEEF.getTing(this.id),i=new paper.Path.Rectangle(new paper.Point(0,0),new paper.Point(10,10)),t=new paper.Path.Rectangle(new paper.Point(KEEF.width-10,KEEF.height-10),new paper.Point(KEEF.width,KEEF.height)),n=i.unite(t);e.frames.push(n),e.numLoaded++,i.data.name="bin",t.data.name="bin",n.data.name="bin",i.data.name2="tl",t.data.name2="br",n.data.name2="bound"}},e.loadingLoop=function(e,i,t){paper.project.importSVG(e+"_"+i+".svg",{expandShapes:!0,onLoad:function(n){var s=KEEF.getTing(t);s.numLoaded++,KEEF.totalLoaded++;for(var a=10,E=n;a>0&&"Path"!=E.className;)E=E.children[0];if(1>=a)throw this.id,this.name,"too many groups/compund paths in svg";E.data.name="bin",s.frames.push(E);var h=document.getElementById("loadingText");h.innerHTML="loaded "+KEEF.totalLoaded+" of "+Math.round(KEEF.totalFrames-1),i<s.numFrames-1&&s.loadingLoop(e,i+1,t)}})},e.isLoaded=function(){return this.numLoaded<this.numFrames?this.loaded=!1:this.loaded=!0,this.loaded},e.setToBin=function(){for(var e=0;e<this.frames.length;e++)this.frames[e].data.name="original svgs"}}}()),function(){if(void 0===KEEF.LineTexture){KEEF.LineTexture=function(e,i,t){this.id=KEEF.createID("lineTexture"),this.name=e,this.still=!1,1==t&&(this.still=!0),this.clip=!0,this.depth=0,this.myLines=[],this.numLines=40,this.lineAngle=0,this.lineColor="blue",this.increment=10,this.lineLength=250,this.tings,this.clipPathesCache=new Array,this.clippingPath,this.clipPosition=new paper.Point(0,0),this.cacheFrameNum=0,this.cached=!1,this.group,this.groupChildren=new Array,this._i};var e=KEEF.LineTexture.prototype;e.init=function(e,i){var t=new paper.Point(e.x+this.lineLength,e.y);for(void 0!==i&&(void 0!==i.numLines&&(this.numLines=i.numLines),void 0!==i.lineLength&&(this.lineLength=i.lineLength),void 0!==i.increment&&(this.increment=i.increment),void 0!==i.angle&&(this.lineAngle=i.angle,t.x=e.x+this.lineLength,t.y=e.y+Math.tan(this.lineAngle)*this.lineLength),void 0!==i.color&&(this.lineColor=i.color),i.shift&&(e.y=e.y-Math.tan(this.lineAngle)*this.lineLength,t.y=t.y-Math.tan(this.lineAngle)*this.lineLength),i.depth&&(this.depth=i.depth)),this._i=0;this._i<this.numLines;this._i++)this.myLines.push(new paper.Path.Line(new paper.Point(e.x,e.y+this.increment*this._i),new paper.Point(t.x,t.y+this.increment*this._i))),this.myLines[this.myLines.length-1].strokeColor=this.lineColor,this.myLines[this.myLines.length-1].data.name="line"},e.update=function(e){this.still||(this.clipPathesCache[this.cacheFrameNum].position=this.clipPosition,this.groupChildren[0]=this.clipPathesCache[this.cacheFrameNum],this.group.children=this.groupChildren,this.group.clipped=this.clip,this.cacheFrameNum++,this.cacheFrameNum>this.clipPathesCache.length-1&&(this.cacheFrameNum=0)),this.clipPosition.x=KEEF.width/2+this.depth*(KEEF.width/2-KEEF.mouse.x)+320,this.clipPosition.y=KEEF.height/2+.7*this.depth*(KEEF.height/2-KEEF.mouse.y)},e.addClipTings=function(e){for(this.tings=e,this.cache(),this.groupChildren.push(this.clipPathesCache[0]),this._i=0;this._i<this.myLines.length;this._i++)this.groupChildren.push(this.myLines[this._i]);this.group=new paper.Group({children:this.groupChildren}),this.group.clipped=this.clip},e.setClipPosition=function(e){this.clipPosition.set(e.x,e.y)},e.cache=function(){for(var e=1;e<this.tings.length;e++)this.tings[e].reset();for(var i=100,t=!1;i>0&&0==t;){for(t=!0,this.clippingPath=this.tings[0].getCurFrame(),this._i=1;this._i<this.tings.length;this._i++)this.clippingPath=this.clippingPath.unite(this.tings[this._i].getCurFrame()),this.tings[this._i].update();for(this.clipPathesCache.push(this.clippingPath),this._i=0;this._i<this.tings.length;this._i++)0!=this.tings.frameNum&&(t=!1);i--}for(this._i=1;this._i<this.tings.length;this._i++)this.clippingPath=this.clippingPath.unite(this.tings[this._i].getCurFrame());for(this._i=1;this._i<this.tings.length;this._i++)this.tings[this._i].setToBin();this.cached=!0,KEEF.totalCached++,console.log("cached");var n=document.getElementById("loadingText");n.innerHTML="processed "+KEEF.totalCached+" of "+KEEF.totalToCache}}}(),function(){if(void 0===KEEF.WhiteTexture){KEEF.WhiteTexture=function(e,i,t){this.id=KEEF.createID("whiteTexture"),this.name=e,this.still=!0,this.clip=!0,this.depth=0,this.tings,this.clipPathesCache=new Array,this.clippingPath,this.clipPosition=new paper.Point(0,0),this.cacheFrameNum=0,this.groupChildren,this.group};var e=KEEF.WhiteTexture.prototype;e.init=function(e,i){void 0!==i&&i.depth&&(this.depth=i.depth)},e.update=function(e){this.clipPathesCache[this.cacheFrameNum].position=this.clipPosition,this.still||(this.groupChildren[0]=this.clipPathesCache[this.cacheFrameNum],this.group.children=this.groupChildren,this.group.clipped=this.clip,this.cacheFrameNum++,this.cacheFrameNum>this.clipPathesCache.length-1&&(this.cacheFrameNum=0)),this.clipPosition.x=KEEF.width/2+this.depth*(KEEF.width/2-KEEF.mouse.x)+320,this.clipPosition.y=KEEF.height/2+.7*this.depth*(KEEF.height/2-KEEF.mouse.y)},e.addClipTings=function(e){this.tings=e,this.cache(),this.groupChildren=new Array,this.groupChildren.push(this.clipPathesCache[0]),this.groupChildren.push(new paper.Path.Rectangle(new paper.Point(0,0),new paper.Point(KEEF.width,KEEF.height))),this.group=new paper.Group({children:this.groupChildren}),this.group.clipped=this.clip,this.group.fillColor=KEEF.color.white},e.setClipPosition=function(e){this.clipPosition.set(e.x,e.y)},e.cache=function(){for(var e=1;e<this.tings.length;e++)this.tings[e].reset();for(var i=100,t=!1;i>0&&0==t;){t=!0,this.clippingPath=this.tings[0].getCurFrame();for(var e=1;e<this.tings.length;e++)this.clippingPath=this.clippingPath.unite(this.tings[e].getCurFrame()),this.tings[e].update();this.clipPathesCache.push(this.clippingPath);for(var e=0;e<this.tings.length;e++)0!=this.tings.frameNum&&(t=!1);i--}for(var e=1;e<this.tings.length;e++)this.clippingPath=this.clippingPath.unite(this.tings[e].getCurFrame());this.cached=!0,KEEF.totalCached++,console.log("cached");var n=document.getElementById("loadingText");n.innerHTML="processed "+KEEF.totalCached+" of "+KEEF.totalToCache}}}(),function(){if(void 0===KEEF.SnowTexture){KEEF.SnowTexture=function(){this.id=KEEF.createID("snowTexture"),this.name="snow",this.still=!1,this.clip=!0,this.depth=0,this.myLines=[],this.numLines=80,this.lineColor=KEEF.color.black,this.increment=KEEF.width/this.numLines,this.lineLength=KEEF.height,this.flakes,this.clipPathesCache=new Array,this.clippingPath,this.clipPosition=new paper.Point(0,0),this.cacheFrameNum=0,this.snowflakes,this.flakes,this.paperFlakes=new Array,this.numFlakes=20,this.compoundPath};var e=KEEF.SnowTexture.prototype;e.init=function(){for(var e=0;e<this.numLines;e++)this.myLines.push(new paper.Path.Line(new paper.Point(this.increment*e,0),new paper.Point(this.increment*e,KEEF.height))),this.myLines[this.myLines.length-1].strokeColor=this.lineColor;for(var e=0;e<this.numFlakes;e++)this.paperFlakes.push(new paper.Path.Circle(new paper.Point(Math.random()*canvas.width,Math.random()*canvas.height),15*Math.random()+5)),this.paperFlakes[this.paperFlakes.length-1].data.speedX=40*Math.random()+5,this.paperFlakes[this.paperFlakes.length-1].data.speedY=40*Math.random()+10;this.compoundPath=new CompoundPath({children:this.paperFlakes}),this.startSnow()},e.update=function(){for(var e=0;e<this.numFlakes;e++)this.compoundPath.children[e].position.x=this.compoundPath.children[e].position.x+this.compoundPath.children[e].data.speedX,this.compoundPath.children[e].position.y=this.compoundPath.children[e].position.y+this.compoundPath.children[e].data.speedY,this.compoundPath.children[e].position.x>canvas.width+100&&(this.compoundPath.children[e].position.x=-100),this.compoundPath.children[e].position.y>canvas.height+100&&(this.compoundPath.children[e].position.y=-100)},e.startSnow=function(){this.flakes=new Array,this.flakes.push(this.compoundPath);for(var e=0;e<this.myLines.length;e++)this.flakes.push(this.myLines[e]);this.snowflakes=new paper.Group({children:this.flakes}),this.snowflakes.clipped=this.clip},e.setClipPosition=function(e){this.clipPosition.set(e.x,e.y)}}}();